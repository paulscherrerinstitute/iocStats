# iocStats module

This module consists of vanilla **iocStats** [sources](https://github.com/epics-modules/iocStats) and PSI specific files and adjustments. PSI specifics are located in [PSI](./PSI) folder and vanilla sources in [iocStats](./iocStats) folder.

## Usage of the iocStats module
To use iocStats module on PSI, module must be requested in statup script.
```
require iocStats
```

## User interfaces (caQtDM panels)
### IOC status
There are PSI specific GUIs located in [./PSI/qt/](./PSI/qt/). They can be installed with: `make installui`.

To start the GUI for specific IOC (e.g. S10-CPPM-MOT0991) following command must be executed:
```
startDM -macro IOC=S10-CPPM-MOT0991 iocStats.ui
```

### SwissFEL IOCs  synoptic overview
There is a helper python script [./PSI/utils/generateIocOverviewGui.py](./PSI/utils/generateIocOverviewGui.py) which provides automatic generation of the overview panel.

```
usage: generateIocOverviewGui.py [-h] [-o OUTFILE] [--sort {domain,type}]
                                 [-c CFGFILE]

Tool generating iocStats overview panel for SwissFEL.

By default it finds all IOCs with iocStats module and sorts them by accelerator sections (SIN, S10, ...).

Using --sort flag, IOCs can also be sorted by the device type.

Groups and corresponding IOCs can also be defined manually using JSON file and option --cfgfile.
JSON file format:
{
    "_tab_order_":["LLRF", "DI"],
    "LLRF": ["SIN-CPPM-TST1", "S20-CPPM-TST2"],
    "DI": ["S10-CPPM-TST1", "S20-CPPM-TST2"]
}

optional arguments:
  -h, --help            show this help message and exit
  -o OUTFILE, --outfile OUTFILE
                        (default: IOC_OVERVIEW.ui) Output ui file.
  --sort {domain,type}  (default: domain) Sort IOCs by:
                            domain (SIN, S10, S20, ...),
                            type (CVME, CPPM, CPCL, ...)
  -c CFGFILE, --cfgfile CFGFILE
                        JSON file defining groups and IOCs (--sort ignored)
```

Currently script supports 3 modes of GUI generation:

1. Automatic IOC detection. Sorting by accelerator section (SIN, S10, ...)
  - Finds all SwissFEL IOCs running iocStats.
  - Filters out those with invalid name.
  - Groups IOCs by accelerator section (each group one tab)

2. Automatic IOC detection. Sorting by the host type (CVME, CPPM, ...)
 - Finds all SwissFEL IOCs running iocStats.
 - Filters out those with invalid name.
 - Groups IOCs by accelerator host type (each group one tab)

3. Use user defined sorting of IOCs into groups. Simple JSON configuration file can be used:
 ```
{
    "_tab_order_":["Group 2", "Group 1"],
    "LLRF": ["SIN-CPPM-TST1", "S20-CPPM-TST2"],
    "DI": ["S10-CPPM-TST1", "S20-CPPM-TST2"]
}
 ```

## Archiver configuration
Channels to be archived per IOC running iocStats are defined in [./PSI/cfg/iocStats.archtmp](./PSI/cfg/iocStats.archtmp).

There is also a helper script which uses the template (it reads it from the last installed vesion!) to generate archiver configuration file for all running IOCs on SwissFEL. Script can be found here: [./PSI/utils/generateArchiverConfig.sh](./PSI/utils/generateArchiverConfig.sh).

To generate archiver configuration following command must be executed:
```
cd ./PSI/utils
./prepare_archiver_for_all.sh
```

S_C_iocStats_all.config will be generated by the script.

### Advanced usage of helper script
`generateArchiverConfig.sh.sh` allows user to specify other than default settings for facility and output file.

```
Usage: ./generateArchiverConfig.sh [options]

Create iocStats archiver configuration for all existing IOCs on defined facility.
existing SwissFEL IOCs.

Options:
    -h                                           This help
    -f FACILITY (default: SWISSFEL)              Use IOCs from defined facility
    -o OUTPUT (default: ./S_C_iocStats.config)   Output file
```

## Updating vanilla sources from upstream reporsitory
Vanilla sources were included as git subtree (which gives us a copy of sources and not only a link as in case of submodules) in folder [iocStats](./iocStats).

To include vanilla updates into this project following must be done:

 1. This repository must be cloned to your machine.
 ```
 git clone https://git.psi.ch/cosylab/iocStats.git
 ```
  
 2. Remote repository to the vanilla sources must be added:
 ```
 git remote add iocStats_remote https://github.com/epics-modules/iocStats.git
 ```
 
 3. Updates from the vanilla source can then be acquired using pull with subtree strategy (-s):
 ```
 git pull -s subtree iocStats_remote master
 ```

 4. Updates must then be pushed to this project.
 ```
 git push origin master
 ```
 
